# Apache Virtual Host Configuration for OpenEMR on FreeBSD
# 
# This configuration uses the static PHP CGI binary to execute PHP files via a wrapper script.
# Update OPENEMR_PATH to match your actual paths.

# Update OPENEMR_PATH to match your installation
Define OPENEMR_PATH /path/to/openemr-extracted

<VirtualHost *:80>
    ServerName localhost
    DocumentRoot "${OPENEMR_PATH}"
    
    # Optional: Enable debug mode for the PHP wrapper script (1 to enable)
    # SetEnv DEBUG_PHP_WRAPPER 1
    
    # Enable mod_rewrite for redirects
    RewriteEngine On
    
    # Redirect root to index.php if no file is specified
    RewriteRule ^$ /index.php [L]
    
    # Configure ScriptAlias for cgi-bin directory (needed for Action directive)
    # The second argument to Action MUST be a URL path, not a file path
    ScriptAlias /cgi-bin/ "${OPENEMR_PATH}/cgi-bin/"
    
    <Directory "${OPENEMR_PATH}/cgi-bin">
        Options +ExecCGI
        Require all granted
    </Directory>

    # Use Action directive to map .php files to the wrapper script
    Action application/x-httpd-php /cgi-bin/php-wrapper.cgi
    AddHandler application/x-httpd-php .php
    
    # ---------------------------------------------------------
    # Optimization for Heavy Load
    # ---------------------------------------------------------
    
    # Enable compression to reduce bandwidth usage
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Connection optimizations
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5

    # Directory configuration
    <Directory "${OPENEMR_PATH}">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html
        
        # Security: Prevent access to sensitive files
        <FilesMatch "\.(git|sql|ini|log|json|lock|md)$">
            Require all denied
        </FilesMatch>
        
        # Deny access to hidden files
        <FilesMatch "^\.">
            Require all denied
        </FilesMatch>
    </Directory>
    
    # Allow CGI execution for the wrapper script
    <FilesMatch "php-wrapper\.cgi$">
        Options +ExecCGI
        Require all granted
        SetHandler cgi-script
    </FilesMatch>
    
    # Static file handling
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </FilesMatch>
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Logging (FreeBSD default paths)
    ErrorLog "/var/log/httpd-openemr-error.log"
    CustomLog "/var/log/httpd-openemr-access.log" common
</VirtualHost>
