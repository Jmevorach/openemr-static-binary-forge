# Apache Virtual Host Configuration for OpenEMR (PHP-FPM)
# 
# This configuration uses PHP-FPM via mod_proxy_fcgi to execute PHP files.
# Update OPENEMR_PATH to match your actual path.
#
# For FreeBSD:
# - Include in /usr/local/etc/apache24/Includes/httpd-openemr-fpm.conf
#
# Prerequisites:
# 1. Enable mod_proxy_fcgi in Apache main config: LoadModule proxy_fcgi_module libexec/apache24/mod_proxy_fcgi.so
# 2. Extract OpenEMR PHAR (use extract-openemr.sh)
# 3. Start PHP-FPM with the provided php-fpm.conf

# Update OPENEMR_PATH to match your installation
Define OPENEMR_PATH /usr/local/www/openemr-extracted

<VirtualHost *:80>
    ServerName localhost
    DocumentRoot "${OPENEMR_PATH}"
    
    # Enable mod_rewrite for redirects
    RewriteEngine On
    
    # Redirect root to index.php if no file is specified
    RewriteRule ^$ /index.php [L]
    
    # Proxy PHP requests to PHP-FPM
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://127.0.0.1:9000"
    </FilesMatch>

    # ---------------------------------------------------------
    # Optimization for Heavy Load
    # ---------------------------------------------------------
    
    # Enable compression to reduce bandwidth usage
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Connection optimizations
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5

    # Directory configuration
    <Directory "${OPENEMR_PATH}">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html
        
        # Security: Prevent access to sensitive files
        <FilesMatch "\.(git|sql|ini|log|json|lock|md)$">
            Require all denied
        </FilesMatch>
        
        # Deny access to hidden files
        <FilesMatch "^\.">
            Require all denied
        </FilesMatch>
    </Directory>
    
    # Static file handling
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </FilesMatch>
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Logging
    ErrorLog "/var/log/openemr_fpm_error.log"
    CustomLog "/var/log/openemr_fpm_access.log" common
</VirtualHost>
