# Apache Virtual Host Configuration for OpenEMR on Linux (amd64)
# 
# This configuration uses the static PHP CGI binary to execute PHP files via a wrapper script.

# Update OPENEMR_PATH to match your installation
Define OPENEMR_PATH /path/to/openemr-extracted

<VirtualHost *:80>
    ServerName localhost
    DocumentRoot "${OPENEMR_PATH}"
    
    # Enable mod_rewrite for redirects
    RewriteEngine On
    
    # Redirect root to index.php if no file is specified
    RewriteRule ^$ /index.php [L]
    
    # Configure ScriptAlias for cgi-bin directory
    ScriptAlias /cgi-bin/ "${OPENEMR_PATH}/cgi-bin/"
    
    <Directory "${OPENEMR_PATH}/cgi-bin">
        Options +ExecCGI
        Require all granted
    </Directory>

    # Use Action directive to map .php files to the wrapper script
    Action application/x-httpd-php /cgi-bin/php-wrapper.cgi
    AddHandler application/x-httpd-php .php
    
    # Optimization for Heavy Load
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5

    # Directory configuration
    <Directory "${OPENEMR_PATH}">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html
        
        # Security: Prevent access to sensitive files
        <FilesMatch "\.(git|sql|ini|log|json|lock|md)$">
            Require all denied
        </FilesMatch>
    </Directory>
    
    # Allow CGI execution for the wrapper script
    <FilesMatch "php-wrapper\.cgi$">
        Options +ExecCGI
        Require all granted
        SetHandler cgi-script
    </FilesMatch>
    
    # Logging (Linux/Debian/Ubuntu default paths)
    ErrorLog ${APACHE_LOG_DIR}/openemr-error.log
    CustomLog ${APACHE_LOG_DIR}/openemr-access.log common
</VirtualHost>
